name: Build & Deploy AL Extension

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  ALGO_VERSION: 'latest'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Install AL Language CLI
      run: |
        dotnet tool install --global al-restore || true
        dotnet tool install --global al-build || true
        echo "$HOME/.dotnet/tools" >> $GITHUB_PATH
    
    - name: Verify AL Files
      run: |
        echo "=== AL Extension Structure ==="
        find . -name "*.al" -type f | head -20
        echo ""
        echo "=== App.json ==="
        cat app.json
    
    - name: Build Extension
      run: |
        # In production, this would compile the .al files
        # For now, validate the structure
        echo "=== Building AL Extension ==="
        
        # Check required files exist
        [ -f "app.json" ] || exit 1
        [ -d "src/Table" ] || exit 1
        
        # Validate app.json
        cat app.json | python3 -m json.tool > /dev/null || exit 1
        
        echo "Build validation passed!"
        echo "Extension: $(cat app.json | python3 -c 'import json,sys; print(json.load(sys.stdin)[\"name\"])')"
        echo "Version: $(cat app.json | python3 -c 'import json,sys; print(json.load(sys.stdin)[\"version\"])')"
    
    - name: Create Artifact
      run: |
        # Package the extension
        mkdir -p artifacts
        tar -czf artifacts/extension.tar.gz \
          app.json \
          src/ \
          --exclude='*.al~' \
          2>/dev/null || true
        ls -la artifacts/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: bc-extension
        path: artifacts/

  deploy-sandbox:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: bc-extension
        path: artifacts/
    
    - name: Deploy to Sandbox
      run: |
        echo "=== Deploying to Business Central Sandbox ==="
        
        # In production, use these steps:
        # 1. Connect to BC Admin Center
        # 2. Upload the .app file
        # 3. Install the extension
        
        echo "Sandbox deployment simulated."
        echo "To enable real deployment, configure these secrets:"
        echo "  - BC_SANDBOX_URL"
        echo "  - BC_API_KEY"
        
        # Show what would be deployed
        ls -la artifacts/

  notify-local:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Notify Local Webhook
      run: |
        # Call local webhook if configured
        if [ -n "${{ secrets.LOCAL_WEBHOOK_URL }}" ]; then
          curl -X POST "${{ secrets.LOCAL_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "build_complete",
              "repo": "BC-Dev-Credit-Control",
              "commit": "${{ github.sha }}",
              "status": "success"
            }'
        fi
      continue-on-error: true
